参考资料：  
[图解 HTTPS：Charles 捕获 HTTPS 的原理](https://github.com/youngwind/blog/issues/108)  


### Charles的工作原理  

参考资料中已经详细说明了Charles的拦截HTTPS的工作原理。下面在说一下自己的理解：  
1、 客户端安装并信任了Charles的根证书；  
2、 Charles首先拦截了服务器传给客户端的证书；  
3、 Charles将自己生成的证书传给了客户端；  
4、 客户端使用Charles根证书解密Charles传给自己的证书，获取到公钥，然后将生成的随机数加密成会话密钥传递出去；  
5、 Charles使用私钥解密获取到随机数，再使用服务器公钥（用本地安装的CA证书解密服务器获取到的证书得到）加密后传递给服务器；  
6、 服务器用私钥解密会话密钥，获取到加密随机数。  
7、 由于Charles已经知道了密钥，所以接下来服务器和客户端的加密通信他都可以解密。  

### 如何防止中间人攻击

从Charles的工作原理不难看出，中间人之所以能够对客户端伪装成服务器、对服务器伪装成客户端，最关键的两步就是：  
手机用户安装信任了中间人的证书；  
客户端拿到证书后只验证了证书是否是系统信任的证书机构颁发的证书，而没有验证证书到底是否是服务器传过来的证书。    

作为手机用户，也要避免随意在手机上安装信任证书，不要随意连接不信任的网络。  
作为开发者，将服务器证书存储到本地，当进行HTTPS通信时，使用本地存储的证书校验一下收到的服务器证书，而不单单是只校验证书签名的合法性。    
